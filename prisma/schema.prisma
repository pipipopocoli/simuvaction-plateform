generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TaskStatus {
  NEW
  DOING
  DONE
  ARCHIVED
}

enum LibraryItemType {
  SOURCE
  DRAFT
}

model Pillar {
  id           String        @id @default(cuid())
  name         String
  slug         String        @unique
  tasks        TaskCard[]
  libraryItems LibraryItem[]
}

model TaskCard {
  id                String             @id @default(cuid())
  pillarId          String
  title             String
  description       String?
  status            TaskStatus         @default(NEW)
  deadline          DateTime
  priority          Int
  urgent            Boolean            @default(false)
  orderIndex        Int                @default(0)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  pillar            Pillar             @relation(fields: [pillarId], references: [id], onDelete: Cascade)
  tags              TaskTag[]
  checklistSections ChecklistSection[]
  attachments       AttachmentLink[]
  libraryItems      LibraryItem[]

  @@index([pillarId, status, orderIndex])
  @@index([deadline])
}

model Tag {
  id    String    @id @default(cuid())
  name  String    @unique
  tasks TaskTag[]
}

model TaskTag {
  taskId String
  tagId  String
  task   TaskCard @relation(fields: [taskId], references: [id], onDelete: Cascade)
  tag    Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([taskId, tagId])
  @@index([tagId])
}

model ChecklistSection {
  id         String          @id @default(cuid())
  taskId     String
  title      String
  orderIndex Int             @default(0)
  task       TaskCard        @relation(fields: [taskId], references: [id], onDelete: Cascade)
  items      ChecklistItem[]

  @@index([taskId, orderIndex])
}

model ChecklistItem {
  id         String           @id @default(cuid())
  sectionId  String
  text       String
  isDone     Boolean          @default(false)
  orderIndex Int              @default(0)
  section    ChecklistSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@index([sectionId, orderIndex])
}

model AttachmentLink {
  id            String      @id @default(cuid())
  taskId        String?
  libraryItemId String?
  title         String
  url           String
  task          TaskCard?   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  libraryItem   LibraryItem? @relation(fields: [libraryItemId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([libraryItemId])
}

model LibraryItem {
  id          String           @id @default(cuid())
  type        LibraryItemType
  title       String
  url         String
  tags        String[]
  pillarId    String?
  taskId      String?
  createdAt   DateTime         @default(now())
  pillar      Pillar?          @relation(fields: [pillarId], references: [id], onDelete: SetNull)
  task        TaskCard?        @relation(fields: [taskId], references: [id], onDelete: SetNull)
  attachments AttachmentLink[]

  @@index([type])
  @@index([pillarId])
  @@index([taskId])
}

model OfficialDeadline {
  id          String   @id @default(cuid())
  title       String
  datetimeCet DateTime
  orderIndex  Int      @unique
}

model WeeklyPlan {
  id              String   @id @default(cuid())
  weekStartCet    DateTime @unique
  generatedAt     DateTime @default(now())
  markdownSummary String
  itemsJson       Json
}

model Meeting {
  id               String   @id @default(cuid())
  datetimeCet      DateTime
  agendaTaskIdsJson Json
  optionalNotes    String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([datetimeCet])
}

model PassphraseAttempt {
  id         String   @id @default(cuid())
  ipHash     String
  attemptedAt DateTime @default(now())
  success    Boolean

  @@index([ipHash, attemptedAt])
}

model AppSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  valueJson Json
  updatedAt DateTime @updatedAt
}

// ----------------------------------------------------------------------------
// WAR ROOM MODELS (Phase 2 Addition)
// ----------------------------------------------------------------------------

model Event {
  id          String    @id @default(cuid())
  name        String
  year        Int
  startDate   DateTime
  endDate     DateTime
  status      String    @default("active")
  createdAt   DateTime  @default(now())

  users           User[]
  teams           Team[]
  chatRooms         ChatRoom[]
  chatMessages      ChatMessage[]
  newsPosts         NewsPost[]
  votes             Vote[]
  voteBallots       VoteBallot[]
  notifications     Notification[]
  auditLogs         AuditLog[]
  deadlines         EventDeadline[]
  documents         EventDocument[]
  twitterConfigs    TwitterConfig[]
}

model User {
  id                 String    @id @default(cuid())
  email              String    @unique
  hashedPassword     String    // By default: bcrypt hashed "1234"
  mustChangePassword Boolean   @default(true)
  resetToken         String?
  resetTokenExpiry   DateTime?
  name               String
  role               String    @default("delegate")
  teamId             String?
  eventId            String
  avatarUrl          String?
  createdAt          DateTime  @default(now())

  team        Team?     @relation(fields: [teamId], references: [id])
  event       Event     @relation(fields: [eventId], references: [id])

  chatRoomsCreated  ChatRoom[]
  chatMemberships   ChatMembership[]
  chatReads         ChatRead[]
  chatMessages      ChatMessage[]
  
  newsPosts         NewsPost[]
  newsApprovals     NewsApproval[]
  
  votesCreated      Vote[]
  voteBallots       VoteBallot[]
  voteRollcalls     VoteRollcall[]
  
  notifications     Notification[]
  deviceTokens      UserDeviceToken[]
  auditLogs         AuditLog[]

  @@index([eventId])
  @@index([teamId])
}

model Team {
  id          String   @id @default(cuid())
  eventId     String
  countryCode String
  countryName String
  stanceShort String?
  stanceLong  String?
  priorities  String[] 
  createdAt   DateTime @default(now())

  event       Event     @relation(fields: [eventId], references: [id])
  users       User[]
  
  chatRooms   ChatRoom[]
  voteEligibilityTeams VoteEligibilityTeam[]
  voteBallots VoteBallot[]

  @@unique([eventId, countryCode])
}

// ----------------------------------------------------------------------------
// CHAT v2.1 (Rooms, Memberships, Reads)
// ----------------------------------------------------------------------------

model ChatRoom {
  id          String   @id @default(cuid())
  eventId     String
  name        String
  roomType    String   // 'global', 'team', 'private'
  teamId      String?
  createdById String
  createdAt   DateTime @default(now())

  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  team        Team?    @relation(fields: [teamId], references: [id], onDelete: SetNull)
  createdBy   User     @relation(fields: [createdById], references: [id])

  memberships ChatMembership[]
  messages    ChatMessage[]
  reads       ChatRead[]

  @@index([eventId, roomType])
  @@index([eventId, teamId])
}

model ChatMembership {
  roomId    String
  userId    String
  role      String   @default("member") // 'owner', 'moderator', 'member'
  joinedAt  DateTime @default(now())

  room      ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([roomId, userId])
  @@index([userId])
}

model ChatRead {
  roomId     String
  userId     String
  lastReadAt DateTime @default(now())

  room       ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([roomId, userId])
}

model ChatMessage {
  id        String   @id @default(cuid())
  eventId   String
  roomId    String
  senderId  String
  body      String
  createdAt DateTime @default(now())
  editedAt  DateTime?
  deletedAt DateTime?
  replyToId String?

  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  room      ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  sender    User     @relation(fields: [senderId], references: [id])
  replyTo   ChatMessage?  @relation("MessageReplies", fields: [replyToId], references: [id])
  replies   ChatMessage[] @relation("MessageReplies")

  @@index([roomId, createdAt])
}

// ----------------------------------------------------------------------------
// NOTIFICATIONS v2.1
// ----------------------------------------------------------------------------

model Notification {
  id        String   @id @default(cuid())
  eventId   String
  userId    String
  type      String   // vote_opened, mention, news_published, etc.
  title     String
  body      String
  deepLink  String?
  priority  String   @default("normal") // low, normal, high, urgent
  createdAt DateTime @default(now())
  readAt    DateTime?

  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([eventId, userId])
}

model UserDeviceToken {
  id         String   @id @default(cuid())
  userId     String
  platform   String   // web, ios, android
  token      String
  createdAt  DateTime @default(now())
  lastSeenAt DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, token])
}

// ----------------------------------------------------------------------------
// VOTING v2.1 (Normalized Options & Ballots)
// ----------------------------------------------------------------------------

model Vote {
  id              String   @id @default(cuid())
  eventId         String
  createdById     String
  title           String
  description     String?
  ballotMode      String   // per_person, per_delegation
  visibility      String   // public, secret
  showLiveResults Boolean  @default(false)
  quorumPercent   Int      @default(0)
  openAt          DateTime?
  closeAt         DateTime?
  status          String   @default("draft") // draft, open, closed, cancelled
  createdAt       DateTime @default(now())

  event           Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  createdBy       User     @relation(fields: [createdById], references: [id])

  options         VoteOption[]
  eligibilityRoles VoteEligibilityRole[]
  eligibilityTeams VoteEligibilityTeam[]
  ballots         VoteBallot[]
  rollcalls       VoteRollcall[]

  @@index([eventId, status, closeAt])
}

model VoteOption {
  id        String   @id @default(cuid())
  voteId    String
  optionKey String
  label     String
  sortOrder Int      @default(0)

  vote      Vote     @relation(fields: [voteId], references: [id], onDelete: Cascade)
  casts     VoteCast[]

  @@unique([voteId, optionKey])
}

model VoteEligibilityRole {
  voteId String
  role   String

  vote   Vote   @relation(fields: [voteId], references: [id], onDelete: Cascade)

  @@id([voteId, role])
}

model VoteEligibilityTeam {
  voteId String
  teamId String

  vote   Vote   @relation(fields: [voteId], references: [id], onDelete: Cascade)
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@id([voteId, teamId])
}

model VoteBallot {
  id          String   @id @default(cuid())
  voteId      String
  eventId     String
  voterUserId String?  // Optional for secret
  voterTeamId String?
  castAt      DateTime @default(now())

  vote        Vote     @relation(fields: [voteId], references: [id], onDelete: Cascade)
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user        User?    @relation(fields: [voterUserId], references: [id])
  team        Team?    @relation(fields: [voterTeamId], references: [id])
  
  cast        VoteCast?

  @@unique([voteId, voterUserId]) // For per-person restriction
}

model VoteCast {
  ballotId String   @id
  optionId String

  ballot   VoteBallot @relation(fields: [ballotId], references: [id], onDelete: Cascade)
  option   VoteOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
}

model VoteRollcall {
  voteId    String
  userId    String
  optionKey String
  castAt    DateTime @default(now())

  vote      Vote     @relation(fields: [voteId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@id([voteId, userId])
}

// ----------------------------------------------------------------------------
// NEWSROOM v2.1 (Approvals)
// ----------------------------------------------------------------------------

model NewsPost {
  id          String   @id @default(cuid())
  eventId     String
  authorId    String
  title       String
  body        String   @db.Text
  status      String   @default("draft") // draft, submitted, published, rejected
  publishedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  author      User     @relation(fields: [authorId], references: [id])
  approvals   NewsApproval[]

  @@index([eventId, status, createdAt(sort: Desc)])
}

model NewsApproval {
  postId       String
  approverId   String
  approverRole String   // journalist, leader, admin
  decision     String   // approve, reject
  reason       String?  @db.Text
  decidedAt    DateTime @default(now())

  post         NewsPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  approver     User     @relation(fields: [approverId], references: [id], onDelete: Cascade)

  @@id([postId, approverId])
  @@index([postId, approverRole, decision])
}

// ----------------------------------------------------------------------------
// AUDIT LOG v2.1
// ----------------------------------------------------------------------------

model AuditLog {
  id         String   @id @default(cuid())
  eventId    String
  actorId    String?
  action     String
  entityType String
  entityId   String?
  metadata   Json     @default("{}")
  createdAt  DateTime @default(now())

  event      Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  actor      User?    @relation(fields: [actorId], references: [id])

  @@index([eventId, createdAt(sort: Desc)])
}

// ----------------------------------------------------------------------------
// ADMIN & SOCIAL v2.2 (Phase 7 Addition)
// ----------------------------------------------------------------------------

model EventDeadline {
  id          String   @id @default(cuid())
  eventId     String
  title       String
  description String?
  date        DateTime
  isGlobal    Boolean  @default(true)
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  createdBy   User     @relation(fields: [createdById], references: [id])

  @@index([eventId, date])
}

model EventDocument {
  id          String   @id @default(cuid())
  eventId     String
  title       String
  description String?
  url         String   // Link to the PDF, Image, etc.
  type        String   @default("pdf")
  createdById String
  createdAt   DateTime @default(now())

  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  createdBy   User     @relation(fields: [createdById], references: [id])

  @@index([eventId])
}

model TwitterConfig {
  id          String   @id @default(cuid())
  eventId     String   @unique
  handle      String?  // The specific profile handle e.g. "SimuVaction"
  hashtag     String?  // Alternatively, track a specific hashtag
  createdAt   DateTime @default(now())

  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
}
