generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TaskStatus {
  NEW
  DOING
  DONE
  ARCHIVED
}

enum LibraryItemType {
  SOURCE
  DRAFT
}

model Pillar {
  id           String        @id @default(cuid())
  name         String
  slug         String        @unique
  tasks        TaskCard[]
  libraryItems LibraryItem[]
}

model TaskCard {
  id                String             @id @default(cuid())
  pillarId          String
  title             String
  description       String?
  status            TaskStatus         @default(NEW)
  deadline          DateTime
  priority          Int
  urgent            Boolean            @default(false)
  orderIndex        Int                @default(0)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  pillar            Pillar             @relation(fields: [pillarId], references: [id], onDelete: Cascade)
  tags              TaskTag[]
  checklistSections ChecklistSection[]
  attachments       AttachmentLink[]
  libraryItems      LibraryItem[]

  @@index([pillarId, status, orderIndex])
  @@index([deadline])
}

model Tag {
  id    String    @id @default(cuid())
  name  String    @unique
  tasks TaskTag[]
}

model TaskTag {
  taskId String
  tagId  String
  task   TaskCard @relation(fields: [taskId], references: [id], onDelete: Cascade)
  tag    Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([taskId, tagId])
  @@index([tagId])
}

model ChecklistSection {
  id         String          @id @default(cuid())
  taskId     String
  title      String
  orderIndex Int             @default(0)
  task       TaskCard        @relation(fields: [taskId], references: [id], onDelete: Cascade)
  items      ChecklistItem[]

  @@index([taskId, orderIndex])
}

model ChecklistItem {
  id         String           @id @default(cuid())
  sectionId  String
  text       String
  isDone     Boolean          @default(false)
  orderIndex Int              @default(0)
  section    ChecklistSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@index([sectionId, orderIndex])
}

model AttachmentLink {
  id            String      @id @default(cuid())
  taskId        String?
  libraryItemId String?
  title         String
  url           String
  task          TaskCard?   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  libraryItem   LibraryItem? @relation(fields: [libraryItemId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([libraryItemId])
}

model LibraryItem {
  id          String           @id @default(cuid())
  type        LibraryItemType
  title       String
  url         String
  tags        String[]
  pillarId    String?
  taskId      String?
  createdAt   DateTime         @default(now())
  pillar      Pillar?          @relation(fields: [pillarId], references: [id], onDelete: SetNull)
  task        TaskCard?        @relation(fields: [taskId], references: [id], onDelete: SetNull)
  attachments AttachmentLink[]

  @@index([type])
  @@index([pillarId])
  @@index([taskId])
}

model OfficialDeadline {
  id          String   @id @default(cuid())
  title       String
  datetimeCet DateTime
  orderIndex  Int      @unique
}

model WeeklyPlan {
  id              String   @id @default(cuid())
  weekStartCet    DateTime @unique
  generatedAt     DateTime @default(now())
  markdownSummary String
  itemsJson       Json
}

model Meeting {
  id               String   @id @default(cuid())
  datetimeCet      DateTime
  agendaTaskIdsJson Json
  optionalNotes    String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([datetimeCet])
}

model PassphraseAttempt {
  id         String   @id @default(cuid())
  ipHash     String
  attemptedAt DateTime @default(now())
  success    Boolean

  @@index([ipHash, attemptedAt])
}

model AppSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  valueJson Json
  updatedAt DateTime @updatedAt
}

// ----------------------------------------------------------------------------
// WAR ROOM MODELS (Phase 2 Addition)
// ----------------------------------------------------------------------------

model Event {
  id          String    @id @default(cuid())
  name        String
  year        Int
  startDate   DateTime
  endDate     DateTime
  status      String    @default("active")
  createdAt   DateTime  @default(now())

  users           User[]
  teams           Team[]
  chatChannels    ChatChannel[]
  chatMessages    ChatMessage[]
  newsPosts       NewsPost[]
  votingPolls     VotingPoll[]
}

model User {
  id          String    @id @default(cuid())
  email       String    @unique
  name        String
  role        String    @default("delegate")
  teamId      String?
  eventId     String
  avatarUrl   String?
  createdAt   DateTime  @default(now())

  team        Team?     @relation(fields: [teamId], references: [id])
  event       Event     @relation(fields: [eventId], references: [id])

  chatMessages    ChatMessage[]
  newsPosts       NewsPost[]
  votingPolls     VotingPoll[]
  votingResponses VotingResponse[]

  @@index([eventId])
  @@index([teamId])
}

model Team {
  id          String   @id @default(cuid())
  eventId     String
  countryCode String
  countryName String
  stanceShort String?
  stanceLong  String?
  priorities  String[] 
  createdAt   DateTime @default(now())

  event       Event     @relation(fields: [eventId], references: [id])
  users       User[]
  chatChannels ChatChannel[]
  votingResponses VotingResponse[]

  @@unique([eventId, countryCode])
}

model ChatChannel {
  id            String   @id @default(cuid())
  eventId       String
  name          String
  isPrivate     Boolean  @default(false)
  teamId        String?
  allowedRoles  String[]
  createdAt     DateTime @default(now())

  event         Event    @relation(fields: [eventId], references: [id])
  team          Team?    @relation(fields: [teamId], references: [id])
  messages      ChatMessage[]
}

model ChatMessage {
  id          String   @id @default(cuid())
  channelId   String
  userId      String
  eventId     String
  content     String
  createdAt   DateTime @default(now())

  channel     ChatChannel @relation(fields: [channelId], references: [id])
  user        User        @relation(fields: [userId], references: [id])
  event       Event       @relation(fields: [eventId], references: [id])

  @@index([channelId])
}

model NewsPost {
  id          String   @id @default(cuid())
  eventId     String
  authorId    String
  title       String
  content     String
  published   Boolean  @default(false)
  publishedAt DateTime?
  approvedBy  String[] 
  createdAt   DateTime @default(now())

  event       Event    @relation(fields: [eventId], references: [id])
  author      User     @relation(fields: [authorId], references: [id])
}

model VotingPoll {
  id            String   @id @default(cuid())
  eventId       String
  creatorId     String
  title         String
  optionsJson   Json
  isSecret      Boolean  @default(false)
  quorumPercent Int      @default(0)
  status        String   @default("draft")
  createdAt     DateTime @default(now())

  event         Event    @relation(fields: [eventId], references: [id])
  creator       User     @relation(fields: [creatorId], references: [id])
  responses     VotingResponse[]
}

model VotingResponse {
  id          String   @id @default(cuid())
  pollId      String
  userId      String
  teamId      String?
  optionId    String
  votedAt     DateTime @default(now())

  poll        VotingPoll @relation(fields: [pollId], references: [id])
  user        User       @relation(fields: [userId], references: [id])
  team        Team?      @relation(fields: [teamId], references: [id])

  @@unique([pollId, userId])
}
