SimuVaction
War Room
Complete Technical Specification for AI Coding Agent
Version 2.0 - Ultra-Complete Edition
Next.js + Supabase + Realtime Multi-Tenant Architecture
Table of Contents
Right-click and select 'Update Field' to refresh page numbers
Executive Summary3
System Architecture Overview4
Technology Stack6
Directory Structure8
Database Schema10
RLS Policies14
Frontend Architecture18
API Endpoints22
Testing Strategy24
Deployment Guide26
GitHub Resources28
1. Executive Summary
SimuVaction War Room is a multi-tenant web application designed for UN-style diplomatic simulations. The platform supports 60-80 concurrent users across multiple roles: Delegates (country teams), Journalists, Lobbyists, Leaders (administrators), and Super Admins.
1.1 Core Features
Interactive World Map with country markers and clustering (MapLibre GL JS)
Real-time chat system with public/private channels (Supabase Realtime)
Newsroom with approval workflow (2 journalists + 1 leader sign-off)
Voting system with public/secret ballots and quorum enforcement
Document drafting with AI copilot integration
Push notifications via Firebase Cloud Messaging
PWA support with offline capabilities
1.2 Architecture Principles
Multi-tenancy by Event ID for yearly simulation instances
Row-Level Security (RLS) for all database access
Real-time synchronization via WebSockets
Serverless deployment on Vercel + Supabase
2. System Architecture Overview
The architecture follows a modern JAMstack pattern with serverless functions, real-time subscriptions, and edge caching. All data access is enforced through PostgreSQL Row-Level Security policies.
2.1 High-Level Architecture
+------------------+      +------------------+      +------------------+|   Next.js App    |      |   Supabase       |      |   External       ||   (Vercel)       |<---->|   (Postgres +    |<---->|   Services       ||                  |  WS  |   Realtime)      |  SQL |                  |+------------------+      +------------------+      +------------------+       |                           |                        |       |                           |                        |       v                           v                        v+-------------+           +----------------+      +------------------+|  PWA Client |           |  Edge Functions|      |  Firebase CM     ||  (Browser)  |           |  (Vercel)      |      |  (Push Notif)    |+-------------+           +----------------+      +------------------+
2.2 Data Flow Patterns
Pattern 1: Real-time Chat
1. User sends message -> POST /api/chat2. Edge Function validates via RLS3. Message inserted to chat_messages table4. Supabase Realtime broadcasts to subscribers5. Clients receive update via WebSocket6. UI updates optimistically then confirms
Pattern 2: Voting System
1. Leader creates poll -> POST /api/votes2. System notifies eligible voters (FCM + in-app)3. Users cast votes -> INSERT voting_responses4. RLS enforces one vote per user/team5. Leader closes poll -> tally calculated6. Results broadcast to eligible viewers
3. Technology Stack
3.1 Frontend Stack
Technology
Repository
Purpose
Next.js
github.com/vercel/next.js
React framework with App Router
TypeScript
github.com/microsoft/TypeScript
Type system
Tailwind CSS
github.com/tailwindlabs/tailwindcss
Utility-first CSS
shadcn/ui
github.com/shadcn-ui/ui
Component library
Zustand
github.com/pmndrs/zustand
State management
TanStack Query
github.com/TanStack/query
Server state
MapLibre GL
github.com/maplibre/maplibre-gl-js
Maps
Tiptap
github.com/ueberdosis/tiptap
Rich text editor
3.2 Backend Stack
Technology
Repository
Purpose
Supabase
github.com/supabase/supabase
Backend platform
PostgreSQL
postgresql.org
Database
Supabase Auth
github.com/supabase/gotrue
JWT auth
Realtime
github.com/supabase/realtime
WebSocket server
Vercel Edge
vercel.com
Edge functions
Firebase CM
firebase.google.com
Push notifications
OpenAI
openai.com
AI integration
3.3 Development Tools
Technology
Repository
Purpose
pnpm
pnpm.io
Package manager
ESLint
eslint.org
Linting
Vitest
vitest.dev
Unit testing
Playwright
playwright.dev
E2E testing
Supabase CLI
supabase.com/docs/guides/cli
DB migrations
4. Directory Structure
The project follows a feature-based directory structure with clear separation of concerns.
simuvaction-war-room/├── app/                          # Next.js App Router│   ├── (auth)/                   # Auth route group│   │   ├── login/│   │   ├── register/│   │   └── callback/│   ├── (dashboard)/              # Protected routes│   │   ├── war-room/             # Public situation room│   │   │   ├── map/│   │   │   ├── newsroom/│   │   │   └── deadlines/│   │   ├── workspace/            # Role-based workspaces│   │   │   ├── delegate/│   │   │   ├── journalist/│   │   │   ├── lobbyist/│   │   │   └── leader/│   │   ├── chat/│   │   ├── votes/│   │   └── profile/│   └── api/                      # API routes├── components/                   # React components│   ├── ui/                       # shadcn/ui components│   ├── layout/│   ├── map/│   ├── chat/│   ├── news/│   ├── votes/│   └── editor/├── hooks/                        # Custom React hooks├── lib/                          # Utility libraries│   ├── supabase/│   ├── utils/│   └── validations/├── types/                        # TypeScript types├── stores/                       # Zustand stores├── services/                     # Business logic├── supabase/                     # Supabase files│   ├── migrations/│   └── functions/├── tests/                        # Test files└── docs/                         # Documentation
5. Database Schema
The database uses PostgreSQL with Supabase. All tables include event_id for multi-tenancy.
5.1 Core Tables
events
CREATE TABLE events (    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),    name VARCHAR(255) NOT NULL,    year INTEGER NOT NULL,    start_date TIMESTAMPTZ NOT NULL,    end_date TIMESTAMPTZ NOT NULL,    status VARCHAR(50) DEFAULT 'active',    created_at TIMESTAMPTZ DEFAULT NOW());
users
CREATE TABLE users (    id UUID PRIMARY KEY REFERENCES auth.users(id),    email VARCHAR(255) NOT NULL,    name VARCHAR(255) NOT NULL,    role VARCHAR(50) DEFAULT 'delegate',    team_id UUID REFERENCES teams(id),    event_id UUID REFERENCES events(id) NOT NULL,    avatar_url TEXT,    created_at TIMESTAMPTZ DEFAULT NOW());CREATE INDEX idx_users_event ON users(event_id);CREATE INDEX idx_users_team ON users(team_id);
teams
CREATE TABLE teams (    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),    event_id UUID REFERENCES events(id) NOT NULL,    country_code VARCHAR(3) NOT NULL,    country_name VARCHAR(255) NOT NULL,    stance_short TEXT,    stance_long TEXT,    priorities TEXT[],    created_at TIMESTAMPTZ DEFAULT NOW(),    UNIQUE(event_id, country_code));
chat_channels
CREATE TABLE chat_channels (    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),    event_id UUID REFERENCES events(id) NOT NULL,    name VARCHAR(255) NOT NULL,    is_private BOOLEAN DEFAULT FALSE,    team_id UUID REFERENCES teams(id),    allowed_roles VARCHAR(50)[],    created_at TIMESTAMPTZ DEFAULT NOW());
chat_messages
CREATE TABLE chat_messages (    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),    channel_id UUID REFERENCES chat_channels(id),    user_id UUID REFERENCES users(id) NOT NULL,    event_id UUID REFERENCES events(id) NOT NULL,    content TEXT NOT NULL,    created_at TIMESTAMPTZ DEFAULT NOW());CREATE INDEX idx_messages_channel ON chat_messages(channel_id);
news_posts
CREATE TABLE news_posts (    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),    event_id UUID REFERENCES events(id) NOT NULL,    author_id UUID REFERENCES users(id) NOT NULL,    title VARCHAR(500) NOT NULL,    content TEXT NOT NULL,    published BOOLEAN DEFAULT FALSE,    published_at TIMESTAMPTZ,    approved_by UUID[] DEFAULT '{}',    created_at TIMESTAMPTZ DEFAULT NOW());
voting_polls
CREATE TABLE voting_polls (    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),    event_id UUID REFERENCES events(id) NOT NULL,    creator_id UUID REFERENCES users(id) NOT NULL,    title VARCHAR(500) NOT NULL,    options JSONB NOT NULL,    is_secret BOOLEAN DEFAULT FALSE,    quorum_percent INTEGER DEFAULT 0,    status VARCHAR(50) DEFAULT 'draft',    created_at TIMESTAMPTZ DEFAULT NOW());
voting_responses
CREATE TABLE voting_responses (    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),    poll_id UUID REFERENCES voting_polls(id),    user_id UUID REFERENCES users(id) NOT NULL,    team_id UUID REFERENCES teams(id),    option_id VARCHAR(100) NOT NULL,    voted_at TIMESTAMPTZ DEFAULT NOW(),    UNIQUE(poll_id, user_id));
6. Row-Level Security Policies
RLS policies enforce data access control at the database level. Every table must have ENABLE ROW LEVEL SECURITY and appropriate policies.
6.1 Helper Functions
-- Check if current user is adminCREATE OR REPLACE FUNCTION public.is_admin()RETURNS BOOLEAN AS $$BEGIN    RETURN EXISTS (        SELECT 1 FROM users         WHERE id = auth.uid() AND role = 'admin'    );END;$$ LANGUAGE plpgsql SECURITY DEFINER;-- Get current user's event_idCREATE OR REPLACE FUNCTION public.current_event_id()RETURNS UUID AS $$BEGIN    RETURN (SELECT event_id FROM users WHERE id = auth.uid());END;$$ LANGUAGE plpgsql SECURITY DEFINER;
6.2 Users Table Policies
ALTER TABLE users ENABLE ROW LEVEL SECURITY;-- SELECT: Users can see themselves, leaders see allCREATE POLICY 'Users view own profile'ON users FOR SELECTTO authenticatedUSING (    id = auth.uid() OR is_admin() OR event_id = current_event_id());-- UPDATE: Users update own, leaders update anyCREATE POLICY 'Users update own profile'ON users FOR UPDATETO authenticatedUSING (id = auth.uid() OR is_admin());
6.3 Teams Table Policies
ALTER TABLE teams ENABLE ROW LEVEL SECURITY;-- SELECT: All users in event can see teamsCREATE POLICY 'Users view teams in event'ON teams FOR SELECTTO authenticatedUSING (event_id = current_event_id());-- UPDATE: Only leadersCREATE POLICY 'Leaders manage teams'ON teams FOR ALLTO authenticatedUSING (is_admin());
6.4 Chat Messages Policies
ALTER TABLE chat_messages ENABLE ROW LEVEL SECURITY;-- SELECT: Users see messages in accessible channelsCREATE POLICY 'View messages in channels'ON chat_messages FOR SELECTTO authenticatedUSING (    event_id = current_event_id()    AND EXISTS (        SELECT 1 FROM chat_channels c        WHERE c.id = channel_id        AND (c.is_private = FALSE OR is_admin())    ));-- INSERT: Users post in accessible channelsCREATE POLICY 'Post in channels'ON chat_messages FOR INSERTTO authenticatedWITH CHECK (    event_id = current_event_id() AND user_id = auth.uid());
6.5 News Posts Policies
ALTER TABLE news_posts ENABLE ROW LEVEL SECURITY;-- SELECT: Published visible to all, drafts to author/leadersCREATE POLICY 'View news posts'ON news_posts FOR SELECTTO authenticatedUSING (    event_id = current_event_id()    AND (published = TRUE OR author_id = auth.uid() OR is_admin()));-- INSERT: Journalists create draftsCREATE POLICY 'Create news drafts'ON news_posts FOR INSERTTO authenticatedWITH CHECK (    event_id = current_event_id()    AND published = FALSE);
6.6 Voting Policies
ALTER TABLE voting_polls ENABLE ROW LEVEL SECURITY;-- Only leaders manage pollsCREATE POLICY 'Leaders manage polls'ON voting_polls FOR ALLTO authenticatedUSING (is_admin());-- voting_responsesALTER TABLE voting_responses ENABLE ROW LEVEL SECURITY;-- Users can vote onceCREATE POLICY 'Cast votes'ON voting_responses FOR INSERTTO authenticatedWITH CHECK (    event_id = current_event_id() AND user_id = auth.uid());
7. Frontend Architecture
7.1 Custom Hooks
// hooks/use-chat.ts - Real-time chat hookexport function useChat(channelId: string) {  const supabase = useSupabase();  const queryClient = useQueryClient();  const { data: messages } = useQuery({    queryKey: ['chat', channelId],    queryFn: async () => {      const { data } = await supabase        .from('chat_messages')        .select('*')        .eq('channel_id', channelId)        .order('created_at');      return data;    },  });  // Subscribe to real-time updates  useEffect(() => {    const subscription = supabase      .channel(`chat:${channelId}`)      .on('postgres_changes', {        event: 'INSERT',        table: 'chat_messages'      }, (payload) => {        // Update cache      })      .subscribe();    return () => subscription.unsubscribe();  }, [channelId]);  return { messages };}
7.2 State Management
// stores/auth-store.tsexport const useAuthStore = create<AuthState>()(  persist(    (set) => ({      user: null,      session: null,      setUser: (user) => set({ user }),      signOut: async () => {        await supabase.auth.signOut();        set({ user: null, session: null });      },    }),    { name: 'auth-storage' }  ));
8. API Endpoints
8.1 Authentication
Method
Endpoint
Description
Access
POST
/api/auth/login
Email/password login
Public
POST
/api/auth/logout
Sign out
Auth
GET
/api/auth/session
Get session
Auth
8.2 Chat
Method
Endpoint
Description
Access
GET
/api/chat/channels
List channels
Auth
POST
/api/chat/channels
Create channel
Leader
GET
/api/chat/channels/:id/messages
Get messages
Member
POST
/api/chat/channels/:id/messages
Send message
Member
8.3 Voting
Method
Endpoint
Description
Access
GET
/api/votes
List polls
Auth
POST
/api/votes
Create poll
Leader
POST
/api/votes/:id/open
Open poll
Leader
POST
/api/votes/:id/close
Close poll
Leader
POST
/api/votes/:id/vote
Cast vote
Eligible
8.4 Edge Functions
// supabase/functions/send-notification/index.tsserve(async (req) => {  const { userId, title, body, data } = await req.json();    // Get FCM token  const { data: user } = await supabase    .from('users')    .select('fcm_token')    .eq('id', userId)    .single();  // Send FCM notification  await fetch(FCM_API_URL, {    method: 'POST',    headers: { Authorization: `Bearer ${token}` },    body: JSON.stringify({      message: {        token: user.fcm_token,        notification: { title, body },        webpush: { fcm_options: { link: data.url } }      }    })  });});
9. Testing Strategy
9.1 Unit Tests
// tests/unit/vote-calculations.test.tsdescribe('Vote Calculations', () => {  it('calculates majority correctly', () => {    const votes = [      { optionId: 'yes' },      { optionId: 'yes' },      { optionId: 'no' }    ];    const results = calculateResults(votes);    expect(results.yes).toBe(2);    expect(results.winner).toBe('yes');  });});
9.2 Integration Tests
// tests/integration/chat-flow.test.tstest('complete chat flow', async ({ page }) => {  await page.goto('/login');  await page.fill('[name=email]', 'user@test.com');  await page.fill('[name=password]', 'password');  await page.click('button[type=submit]');  await page.waitForURL('/dashboard');    await page.click('text=Chat');  await page.fill('[data-testid=input]', 'Hello!');  await page.click('[data-testid=send]');    await expect(page.locator('text=Hello!')).toBeVisible();});
9.3 E2E Tests
// tests/e2e/voting-scenario.test.tstest('complete voting', async ({ page }) => {  // Leader creates poll  await login(page, 'leader@test.com');  await page.click('text=Votes');  await page.click('text=Create Poll');  await page.fill('[name=title]', 'Test Vote');  await page.click('text=Create');    // Delegate votes  await login(page, 'delegate@test.com');  await page.click('text=Test Vote');  await page.click('text=Yes');  await page.click('text=Submit');    await expect(page.locator('text=Vote Recorded')).toBeVisible();});
10. Deployment Guide
10.1 Environment Variables
# .env.localNEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.coNEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-keySUPABASE_SERVICE_ROLE_KEY=your-service-role-keyNEXT_PUBLIC_FIREBASE_API_KEY=your-firebase-keyNEXT_PUBLIC_FIREBASE_PROJECT_ID=your-project-idOPENAI_API_KEY=sk-your-openai-keyNEXT_PUBLIC_APP_URL=http://localhost:3000
10.2 Vercel Config
{  'version': 2,  'crons': [    {      'path': '/api/cron/close-expired-votes',      'schedule': '*/5 * * * *'    }  ]}
10.3 GitHub Actions
# .github/workflows/deploy.ymlname: Deployon:  push:    branches: [main]jobs:  test:    runs-on: ubuntu-latest    steps:      - uses: actions/checkout@v4      - name: Setup Node        uses: actions/setup-node@v4        with:          node-version: '20'      - run: pnpm install      - run: pnpm test  deploy:    needs: test    runs-on: ubuntu-latest    steps:      - uses: vercel/action-deploy@v1
11. GitHub Resources
11.1 Core Frameworks
Name
Repository
Description
Next.js
github.com/vercel/next.js
React framework
React
github.com/facebook/react
UI library
TypeScript
github.com/microsoft/TypeScript
Type system
Tailwind CSS
github.com/tailwindlabs/tailwindcss
CSS framework
shadcn/ui
github.com/shadcn-ui/ui
Components
11.2 Database
Name
Repository
Description
Supabase
github.com/supabase/supabase
Backend platform
Supabase JS
github.com/supabase/supabase-js
JS client
Realtime
github.com/supabase/realtime
WebSockets
GoTrue
github.com/supabase/gotrue
Auth
11.3 State Management
Name
Repository
Description
Zustand
github.com/pmndrs/zustand
State
TanStack Query
github.com/TanStack/query
Server state
Zod
github.com/colinhacks/zod
Validation
11.4 Maps
Name
Repository
Description
MapLibre GL
github.com/maplibre/maplibre-gl-js
Maps
react-map-gl
github.com/visgl/react-map-gl
React maps
Supercluster
github.com/mapbox/supercluster
Clustering
11.5 Testing
Name
Repository
Description
Vitest
github.com/vitest-dev/vitest
Unit tests
Playwright
github.com/microsoft/playwright
E2E tests
RTL
github.com/testing-library/react-testing-library
Component tests
11.6 Documentation
Name
Repository
Description
Next.js Docs
nextjs.org/docs
Official docs
Supabase Docs
supabase.com/docs
Official docs
Tailwind Docs
tailwindcss.com/docs
Official docs
RLS Patterns
supabase.com/docs/guides/auth/row-level-security
RLS guide
SimuVaction War Room
Technical Specification v2.0
Built with Next.js + Supabase + TypeScript
2024 - Multi-Tenant Real-time Application